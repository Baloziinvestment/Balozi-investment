<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Group Savings Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
    h1,h2 { margin: 10px 0; }
    .muted { color:#666; font-size: 13px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0; }
    input, select { padding: 10px; border:1px solid #ddd; border-radius: 8px; }
    button { padding: 10px 12px; border:1px solid #ddd; border-radius: 8px; cursor:pointer; background:#fff; }
    button:hover { background:#f7f7f7; }

    .tabs { display:flex; gap:8px; margin: 10px 0 14px; }
    .tabBtn { border:1px solid #ddd; border-radius: 999px; padding: 8px 12px; background:#fff; }
    .tabBtn.active { background:#111; color:#fff; border-color:#111; }

    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 10px; margin: 10px 0; }
    .card { border:1px solid #ddd; border-radius: 10px; padding: 12px; }
    .big { font-size: 20px; font-weight: 700; }

    .box { border:1px solid #eee; border-radius: 10px; padding: 12px; }
    .scroll { overflow:auto; max-height: 70vh; border:1px solid #eee; border-radius: 10px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 9px; text-align:left; }
    th { background:#fafafa; position: sticky; top: 0; z-index: 1; }
    tr.clickable:hover { background:#f9f9f9; cursor:pointer; }

    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; font-size: 12px; margin-right:6px; }
    .ok { color:#0b6b2e; }
    .warn { color:#8a4b00; }
    .err { color:#b00020; }

    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Group Savings Portal</h1>

  <div class="row">
    <span class="pill" id="statusPill">Loading…</span>
    <span class="muted">Last updated: <b id="updated">—</b></span>
    <button onclick="loadData(true)">Refresh</button>
  </div>

  <div class="muted" id="sourceInfo"></div>

  <!-- MAIN TOTALS BY CATEGORY (Deposits only) -->
  <div class="cards">
    <div class="card">
      <div class="muted">Monthly contributions total</div>
      <div class="big" id="totMonthly">—</div>
    </div>
    <div class="card">
      <div class="muted">Posting contributions total</div>
      <div class="big" id="totPosting">—</div>
    </div>
    <div class="card">
      <div class="muted">Operations contributions total</div>
      <div class="big" id="totOperations">—</div>
    </div>
    <div class="card">
      <div class="muted">Grand total (all categories)</div>
      <div class="big" id="totGrand">—</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tabBtn active" id="tabMembersBtn" onclick="showTab('members')">Members</button>
    <button class="tabBtn" id="tabStatementBtn" onclick="showTab('statement')">Member Statement</button>
  </div>

  <!-- TAB: MEMBERS -->
  <div id="tabMembers" class="box">
    <div class="row">
      <input id="memberSearch" placeholder="Search member…" oninput="renderMembers()" style="min-width:260px;" />
      <span class="muted">Click a member to open their statement.</span>
    </div>

    <div class="scroll">
      <table>
        <thead>
          <tr>
            <th>Member</th>
            <th>Total Monthly</th>
            <th>Total Posting</th>
            <th>Total Operations</th>
            <th>Total (All)</th>
            <th>Last contribution date</th>
          </tr>
        </thead>
        <tbody id="membersRows"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB: STATEMENT -->
  <div id="tabStatement" class="box hidden">
    <div class="row">
      <select id="memberSelect" onchange="renderStatement()">
        <option value="">Select a member…</option>
      </select>

      <select id="categoryFilter" onchange="renderStatement()">
        <option value="">All categories</option>
        <option value="Monthly">Monthly</option>
        <option value="Posting">Posting</option>
        <option value="Operations">Operations</option>
        <option value="Uncategorised">Uncategorised</option>
      </select>

      <button onclick="downloadMemberStatement()">Download statement CSV</button>
      <button onclick="window.print()">Print</button>
    </div>

    <!-- MEMBER BREAKDOWN BY CATEGORY (Deposits only) -->
    <div class="cards" style="margin-top:0;">
      <div class="card">
        <div class="muted">Monthly (since start)</div>
        <div class="big" id="mMonthly">—</div>
      </div>
      <div class="card">
        <div class="muted">Posting (since start)</div>
        <div class="big" id="mPosting">—</div>
      </div>
      <div class="card">
        <div class="muted">Operations (since start)</div>
        <div class="big" id="mOperations">—</div>
      </div>
      <div class="card">
        <div class="muted">Total (all categories)</div>
        <div class="big" id="mTotalAll">—</div>
      </div>
    </div>

    <div class="muted" id="mHint">Pick a member to see how and when they contributed.</div>

    <div class="scroll" style="max-height: 60vh;">
      <table>
        <thead>
          <tr><th>Date</th><th>Category</th><th>Type</th><th>Amount</th><th>Note</th></tr>
        </thead>
        <tbody id="statementRows"></tbody>
      </table>
    </div>
  </div>

<script>
  // --- Settings ---
  // If Google Sheets works, use it. If it fails, use GitHub raw.
  const GOOGLE_SHEETS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTgt59-GVyVkiFgAkNHa2ngI71zTrMyYclh_YrgDL29HTCmEe7BdXJtbzGD5J53OdxYRiUu7S6CYa82/pub?gid=1685892762&single=true&output=csv";
  const CSV_FILENAME = "Portal_Transactions_20260108.csv"; // if hosting in GitHub repo root

  let allRows = [];
  let membersSummary = [];
  let lastDataSource = "";

  function setStatus(text, cls="ok") {
    const p = document.getElementById("statusPill");
    p.textContent = text;
    p.className = "pill " + cls;
  }

  function cleanStr(x) { return String(x ?? "").replace(/\uFEFF/g, "").trim(); }
  function normalizeSpaces(x){ return cleanStr(x).replace(/\s+/g, " "); }

  function money(n) {
    if (!isFinite(n)) return "0";
    return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  function toNumber(x) {
    const v = cleanStr(x).replace(/,/g, "").replace(/[^\d.\-]/g, "");
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  }

  function normalizeType(x) {
    const t = cleanStr(x).toLowerCase();
    if (!t) return "";
    if (t.includes("withdraw") || t.includes("debit") || t.includes("wd")) return "Withdrawal";
    if (t.includes("deposit") || t.includes("credit") || t.includes("contrib")) return "Deposit";
    if (t === "deposit") return "Deposit";
    if (t === "withdrawal") return "Withdrawal";
    return cleanStr(x);
  }

  function normalizeCategory(x) {
    const c = normalizeSpaces(x);
    if (!c) return "Uncategorised";
    const lc = c.toLowerCase();
    if (lc.includes("month")) return "Monthly";
    if (lc.includes("post")) return "Posting";
    if (lc.includes("oper") || lc.includes("oc")) return "Operations";
    return c; // keep as-is if user adds new categories later
  }

  function parseDateSortable(s) {
    const x = cleanStr(s);
    if (!x) return null;
    if (/^\d{4}-\d{2}-\d{2}$/.test(x)) return x;
    const d = new Date(x);
    if (isNaN(d.getTime())) return null;
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function detectDelimiter(firstLine) {
    const commas = (firstLine.match(/,/g) || []).length;
    const tabs = (firstLine.match(/\t/g) || []).length;
    return tabs > commas ? "\t" : ",";
  }

  function parseDelimited(text, delimiter) {
    const rows = [];
    let row = [], cell = "", inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (c === '"' && inQuotes && next === '"') { cell += '"'; i++; }
      else if (c === '"') { inQuotes = !inQuotes; }
      else if (c === delimiter && !inQuotes) { row.push(cell); cell = ""; }
      else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (c === '\r' && next === '\n') i++;
        row.push(cell);
        if (row.some(x => cleanStr(x) !== "")) rows.push(row);
        row = []; cell = "";
      } else {
        cell += c;
      }
    }
    row.push(cell);
    if (row.some(x => cleanStr(x) !== "")) rows.push(row);

    const headersRaw = rows.shift() || [];
    const headers = headersRaw.map(h => normalizeSpaces(h));
    return rows.map(cols => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = normalizeSpaces(cols[idx] ?? ""));
      return obj;
    });
  }

  function showTab(which) {
    const members = document.getElementById("tabMembers");
    const statement = document.getElementById("tabStatement");
    const b1 = document.getElementById("tabMembersBtn");
    const b2 = document.getElementById("tabStatementBtn");

    if (which === "members") {
      members.classList.remove("hidden");
      statement.classList.add("hidden");
      b1.classList.add("active");
      b2.classList.remove("active");
    } else {
      statement.classList.remove("hidden");
      members.classList.add("hidden");
      b2.classList.add("active");
      b1.classList.remove("active");
    }
  }

  // Sum contributions (Deposits only) by category
  function sumByCategory(rows, memberName=null) {
    const totals = new Map();
    for (const r of rows) {
      if (memberName && normalizeSpaces(r.Member) !== memberName) continue;
      if (normalizeType(r.Type) !== "Deposit") continue; // contributions
      const cat = normalizeCategory(r.Category);
      const amt = toNumber(r.Amount);
      totals.set(cat, (totals.get(cat) || 0) + amt);
    }
    return totals;
  }

  function setMainTotals() {
    const t = sumByCategory(allRows);
    const monthly = t.get("Monthly") || 0;
    const posting = t.get("Posting") || 0;
    const operations = t.get("Operations") || 0;
    const grand = Array.from(t.values()).reduce((a,b)=>a+b, 0);

    document.getElementById("totMonthly").textContent = money(monthly);
    document.getElementById("totPosting").textContent = money(posting);
    document.getElementById("totOperations").textContent = money(operations);
    document.getElementById("totGrand").textContent = money(grand);
  }

  function computeMembersSummary() {
    const map = new Map();

    for (const r of allRows) {
      const member = normalizeSpaces(r.Member);
      if (!member) continue;

      const type = normalizeType(r.Type);
      const amt = toNumber(r.Amount);
      const date = parseDateSortable(r.Date);
      const cat = normalizeCategory(r.Category);

      if (!map.has(member)) {
        map.set(member, { member, monthly:0, posting:0, operations:0, total:0, lastDate:null });
      }
      const s = map.get(member);

      // We count "contributions" as deposits
      if (type === "Deposit") {
        if (cat === "Monthly") s.monthly += amt;
        else if (cat === "Posting") s.posting += amt;
        else if (cat === "Operations") s.operations += amt;
        s.total += amt;

        if (date && (!s.lastDate || date > s.lastDate)) s.lastDate = date;
      }
    }

    membersSummary = Array.from(map.values()).sort((a,b)=> b.total - a.total);
  }

  function buildMemberSelectOptions() {
    const sel = document.getElementById("memberSelect");
    const current = sel.value;

    const names = membersSummary.map(m => m.member).sort((a,b)=>a.localeCompare(b));
    sel.innerHTML = `<option value="">Select a member…</option>` +
      names.map(n => `<option value="${n.replace(/"/g,"&quot;")}">${n}</option>`).join("");

    if (names.includes(current)) sel.value = current;
  }

  function renderMembers() {
    const q = cleanStr(document.getElementById("memberSearch").value).toLowerCase();
    const rows = q ? membersSummary.filter(m => m.member.toLowerCase().includes(q)) : membersSummary;

    const tbody = document.getElementById("membersRows");
    tbody.innerHTML = "";

    for (const m of rows) {
      const tr = document.createElement("tr");
      tr.className = "clickable";
      tr.innerHTML = `
        <td>${m.member}</td>
        <td>${money(m.monthly)}</td>
        <td>${money(m.posting)}</td>
        <td>${money(m.operations)}</td>
        <td>${money(m.total)}</td>
        <td>${m.lastDate || ""}</td>
      `;
      tr.onclick = () => {
        document.getElementById("memberSelect").value = m.member;
        showTab("statement");
        renderStatement();
      };
      tbody.appendChild(tr);
    }
  }

  function renderStatement() {
    const member = normalizeSpaces(document.getElementById("memberSelect").value);
    const catFilter = normalizeSpaces(document.getElementById("categoryFilter").value);
    const hint = document.getElementById("mHint");
    const tbody = document.getElementById("statementRows");

    if (!member) {
      hint.textContent = "Pick a member to see how and when they contributed.";
      document.getElementById("mMonthly").textContent = "—";
      document.getElementById("mPosting").textContent = "—";
      document.getElementById("mOperations").textContent = "—";
      document.getElementById("mTotalAll").textContent = "—";
      tbody.innerHTML = "";
      return;
    }

    // Member totals by category (Deposits only)
    const t = sumByCategory(allRows, member);
    const monthly = t.get("Monthly") || 0;
    const posting = t.get("Posting") || 0;
    const operations = t.get("Operations") || 0;
    const totalAll = Array.from(t.values()).reduce((a,b)=>a+b, 0);

    document.getElementById("mMonthly").textContent = money(monthly);
    document.getElementById("mPosting").textContent = money(posting);
    document.getElementById("mOperations").textContent = money(operations);
    document.getElementById("mTotalAll").textContent = money(totalAll);

    hint.textContent = `Statement for: ${member} (since start)` + (catFilter ? ` | Category: ${catFilter}` : "");

    const rows = allRows
      .filter(r => normalizeSpaces(r.Member) === member)
      .map(r => ({
        Date: parseDateSortable(r.Date) || cleanStr(r.Date),
        Category: normalizeCategory(r.Category),
        Type: normalizeType(r.Type),
        Amount: cleanStr(r.Amount),
        Note: cleanStr(r.Note)
      }))
      .filter(r => !catFilter || r.Category === catFilter)
      .sort((a,b) => (parseDateSortable(b.Date) || "").localeCompare(parseDateSortable(a.Date) || ""));

    tbody.innerHTML = "";
    for (const r of rows) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.Date || ""}</td>
        <td>${r.Category || ""}</td>
        <td>${r.Type || ""}</td>
        <td>${r.Amount || ""}</td>
        <td>${r.Note || ""}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function downloadCSV(rows, filename) {
    const headers = ["Date","Member","Type","Category","Amount","Note"];
    const lines = [headers.join(",")];

    for (const r of rows) {
      const values = [
        parseDateSortable(r.Date) || cleanStr(r.Date),
        normalizeSpaces(r.Member),
        normalizeType(r.Type),
        normalizeCategory(r.Category),
        cleanStr(r.Amount),
        cleanStr(r.Note)
      ].map(v => `"${String(v).replace(/"/g,'""')}"`);
      lines.push(values.join(","));
    }

    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function downloadMemberStatement() {
    const member = normalizeSpaces(document.getElementById("memberSelect").value);
    if (!member) { alert("Select a member first."); return; }

    const catFilter = normalizeSpaces(document.getElementById("categoryFilter").value);

    const rows = allRows
      .filter(r => normalizeSpaces(r.Member) === member)
      .map(r => ({
        Date: parseDateSortable(r.Date) || cleanStr(r.Date),
        Member: member,
        Type: normalizeType(r.Type),
        Category: normalizeCategory(r.Category),
        Amount: cleanStr(r.Amount),
        Note: cleanStr(r.Note)
      }))
      .filter(r => !catFilter || r.Category === catFilter)
      .sort((a,b) => (parseDateSortable(a.Date) || "").localeCompare(parseDateSortable(b.Date) || ""));

    downloadCSV(rows, `${member.replace(/\s+/g,"_")}_statement.csv`);
  }

  function buildGithubRawUrl() {
    const host = window.location.hostname; // username.github.io
    const path = window.location.pathname.replace(/^\/+/, "");
    const parts = path.split("/").filter(Boolean);

    const username = host.endsWith(".github.io") ? host.replace(".github.io", "") : "";
    const repo = parts.length ? parts[0] : (username ? `${username}.github.io` : "");

    if (!username || !repo) return "";
    return `https://raw.githubusercontent.com/${username}/${repo}/main/${CSV_FILENAME}`;
  }

  async function fetchText(url) {
    const res = await fetch(url + (url.includes("?") ? "&" : "?") + "t=" + Date.now());
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    return await res.text();
  }

  async function loadData(manual=false) {
    setStatus(manual ? "Refreshing…" : "Loading…", "warn");

    const githubRaw = buildGithubRawUrl();
    const candidates = [
      { name: "Google Sheets", url: GOOGLE_SHEETS_URL },
      { name: "GitHub Raw", url: githubRaw }
    ].filter(x => x.url);

    try {
      let text = "";
      let used = null;

      for (const c of candidates) {
        try {
          const t = cleanStr(await fetchText(c.url));
          if (t.toLowerCase().includes("<html")) throw new Error("HTML returned");
          text = t;
          used = c;
          break;
        } catch (e) {}
      }

      if (!used) {
        setStatus("Error loading data", "err");
        document.getElementById("sourceInfo").textContent =
          "Could not load from Google Sheets or GitHub Raw. If using GitHub Raw: upload " + CSV_FILENAME + " to the repo root (same folder as index.html).";
        return;
      }

      lastDataSource = `${used.name}: ${used.url}`;
      document.getElementById("sourceInfo").textContent = "Data source: " + lastDataSource;

      const firstLine = (text.split(/\r?\n/)[0] || "");
      const delim = detectDelimiter(firstLine);
      const parsed = parseDelimited(text, delim);

      // Expecting Date, Member, Type, Category, Amount, Note (Category optional)
      allRows = parsed
        .map(r => ({
          Date: parseDateSortable(r.Date) || cleanStr(r.Date),
          Member: normalizeSpaces(r.Member),
          Type: normalizeType(r.Type),
          Category: normalizeCategory(r.Category),
          Amount: cleanStr(r.Amount),
          Note: cleanStr(r.Note)
        }))
        .filter(r => (r.Date || r.Member || r.Type || r.Amount || r.Note));

      setMainTotals();
      computeMembersSummary();
      buildMemberSelectOptions();
      renderMembers();
      renderStatement();

      document.getElementById("updated").textContent = new Date().toLocaleString();
      setStatus(allRows.length ? "Live" : "Live (0 rows)", allRows.length ? "ok" : "warn");
    } catch (e) {
      console.error(e);
      setStatus("Error loading data", "err");
      document.getElementById("sourceInfo").textContent =
        "Error loading data. If using GitHub Raw: upload " + CSV_FILENAME + " to the repo root (same folder as index.html).";
    }
  }

  loadData(false);
  setInterval(() => loadData(false), 30000);
</script>
</body>
</html>
