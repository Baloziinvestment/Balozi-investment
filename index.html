<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Group Savings Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
    h1,h2,h3 { margin: 10px 0; }
    .muted { color:#666; font-size: 13px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0; }
    input, select { padding: 10px; border:1px solid #ddd; border-radius: 8px; }
    button { padding: 10px 12px; border:1px solid #ddd; border-radius: 8px; cursor:pointer; background:#fff; }
    button:hover { background:#f7f7f7; }

    .tabs { display:flex; gap:8px; margin: 10px 0 14px; }
    .tabBtn { border:1px solid #ddd; border-radius: 999px; padding: 8px 12px; background:#fff; }
    .tabBtn.active { background:#111; color:#fff; border-color:#111; }

    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 10px; margin: 10px 0; }
    .card { border:1px solid #ddd; border-radius: 10px; padding: 12px; }
    .big { font-size: 20px; font-weight: 700; }

    .box { border:1px solid #eee; border-radius: 10px; padding: 12px; }
    .scroll { overflow:auto; max-height: 65vh; border:1px solid #eee; border-radius: 10px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 9px; text-align:left; }
    th { background:#fafafa; position: sticky; top: 0; z-index: 1; }
    tr.clickable:hover { background:#f9f9f9; cursor:pointer; }

    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; font-size: 12px; margin-right:6px; }
    .ok { color:#0b6b2e; }
    .warn { color:#8a4b00; }
    .err { color:#b00020; }

    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>Group Savings Portal</h1>

  <div class="row">
    <span class="pill" id="statusPill">Loading…</span>
    <span class="muted">Last updated: <b id="updated">—</b></span>
    <button onclick="loadData(true)">Refresh</button>
  </div>

  <div class="cards">
    <div class="card">
      <div class="muted">Total Deposits</div>
      <div class="big" id="totDeposits">—</div>
    </div>
    <div class="card">
      <div class="muted">Total Withdrawals</div>
      <div class="big" id="totWithdrawals">—</div>
    </div>
    <div class="card">
      <div class="muted">Current Balance</div>
      <div class="big" id="totBalance">—</div>
    </div>
    <div class="card">
      <div class="muted">Members</div>
      <div class="big" id="memberCount">—</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tabBtn active" id="tabMembersBtn" onclick="showTab('members')">Members</button>
    <button class="tabBtn" id="tabStatementBtn" onclick="showTab('statement')">Member Statement</button>
  </div>

  <!-- TAB: MEMBERS -->
  <div id="tabMembers" class="box">
    <div class="row">
      <input id="memberSearch" placeholder="Search member…" oninput="renderMembers()" style="min-width:260px;" />
      <span class="muted">Click a member to open their statement.</span>
    </div>

    <div class="scroll">
      <table>
        <thead>
          <tr>
            <th>Member</th>
            <th>Total Deposits</th>
            <th>Total Withdrawals</th>
            <th>Net</th>
            <th>Last Deposit Date</th>
          </tr>
        </thead>
        <tbody id="membersRows"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB: STATEMENT -->
  <div id="tabStatement" class="box hidden">
    <div class="row">
      <select id="memberSelect" onchange="renderStatement()">
        <option value="">Select a member…</option>
      </select>
      <button onclick="downloadMemberStatement()">Download statement CSV</button>
      <button onclick="window.print()">Print</button>
    </div>

    <div class="cards" style="margin-top:0;">
      <div class="card">
        <div class="muted">Deposits (since start)</div>
        <div class="big" id="mDeposits">—</div>
      </div>
      <div class="card">
        <div class="muted">Withdrawals</div>
        <div class="big" id="mWithdrawals">—</div>
      </div>
      <div class="card">
        <div class="muted">Net</div>
        <div class="big" id="mNet">—</div>
      </div>
    </div>

    <div class="muted" id="mHint">Pick a member to see how and when they contributed.</div>

    <div class="scroll" style="max-height: 55vh;">
      <table>
        <thead>
          <tr><th>Date</th><th>Type</th><th>Amount</th><th>Note</th></tr>
        </thead>
        <tbody id="statementRows"></tbody>
      </table>
    </div>
  </div>

<script>
  // Your published Google Sheets CSV link
  const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTgt59-GVyVkiFgAkNHa2ngI71zTrMyYclh_YrgDL29HTCmEe7BdXJtbzGD5J53OdxYRiUu7S6CYa82/pub?gid=627544282&single=true&output=csv";

  let allRows = [];
  let membersSummary = []; // computed summaries

  function setStatus(text, cls="ok") {
    const p = document.getElementById("statusPill");
    p.textContent = text;
    p.className = "pill " + cls;
  }

  function cleanStr(x) { return String(x ?? "").replace(/\uFEFF/g, "").trim(); }
  function normalizeSpaces(x){ return cleanStr(x).replace(/\s+/g, " "); }

  function money(n) {
    if (!isFinite(n)) return "0";
    return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  function toNumber(x) {
    const v = cleanStr(x).replace(/,/g, "").replace(/[^\d.\-]/g, "");
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  }

  function normalizeType(x) {
    const t = cleanStr(x).toLowerCase();
    if (!t) return "";
    if (t.includes("withdraw") || t.includes("debit") || t.includes("wd")) return "Withdrawal";
    if (t.includes("deposit") || t.includes("credit") || t.includes("contrib")) return "Deposit";
    if (t === "deposit") return "Deposit";
    if (t === "withdrawal") return "Withdrawal";
    return cleanStr(x);
  }

  function pick(row, key) {
    const direct = row[key];
    if (direct != null) return direct;
    const found = Object.keys(row).find(h => h.toLowerCase() === key.toLowerCase());
    return found ? row[found] : "";
  }

  function parseDateSortable(s) {
    const x = cleanStr(s);
    if (!x) return null;
    if (/^\d{4}-\d{2}-\d{2}$/.test(x)) return x;
    const d = new Date(x);
    if (isNaN(d.getTime())) return null;
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // Robust delimited parser (CSV/TSV) with quotes
  function detectDelimiter(firstLine) {
    const commas = (firstLine.match(/,/g) || []).length;
    const tabs = (firstLine.match(/\t/g) || []).length;
    return tabs > commas ? "\t" : ",";
  }

  function parseDelimited(text, delimiter) {
    const rows = [];
    let row = [], cell = "", inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (c === '"' && inQuotes && next === '"') { cell += '"'; i++; }
      else if (c === '"') { inQuotes = !inQuotes; }
      else if (c === delimiter && !inQuotes) { row.push(cell); cell = ""; }
      else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (c === '\r' && next === '\n') i++;
        row.push(cell);
        if (row.some(x => cleanStr(x) !== "")) rows.push(row);
        row = []; cell = "";
      } else {
        cell += c;
      }
    }
    row.push(cell);
    if (row.some(x => cleanStr(x) !== "")) rows.push(row);

    const headersRaw = rows.shift() || [];
    const headers = headersRaw.map(h => normalizeSpaces(h));
    return rows.map(cols => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = normalizeSpaces(cols[idx] ?? ""));
      return obj;
    });
  }

  function totals(rows) {
    let dep=0, wd=0;
    for (const r of rows) {
      const t = normalizeType(pick(r,"Type")).toLowerCase();
      const a = toNumber(pick(r,"Amount"));
      if (t === "deposit") dep += a;
      else if (t === "withdrawal") wd += a;
    }
    return { dep, wd, bal: dep - wd };
  }

  function showTab(which) {
    const members = document.getElementById("tabMembers");
    const statement = document.getElementById("tabStatement");
    const b1 = document.getElementById("tabMembersBtn");
    const b2 = document.getElementById("tabStatementBtn");

    if (which === "members") {
      members.classList.remove("hidden");
      statement.classList.add("hidden");
      b1.classList.add("active");
      b2.classList.remove("active");
    } else {
      statement.classList.remove("hidden");
      members.classList.add("hidden");
      b2.classList.add("active");
      b1.classList.remove("active");
    }
  }

  function buildMemberSelectOptions() {
    const sel = document.getElementById("memberSelect");
    const current = sel.value;

    const names = membersSummary.map(m => m.member).sort((a,b)=>a.localeCompare(b));
    sel.innerHTML = `<option value="">Select a member…</option>` +
      names.map(n => `<option value="${n.replace(/"/g,"&quot;")}">${n}</option>`).join("");

    if (names.includes(current)) sel.value = current;
  }

  function computeMembersSummary() {
    const map = new Map();

    for (const r of allRows) {
      const member = normalizeSpaces(pick(r, "Member"));
      if (!member) continue;

      const type = normalizeType(pick(r, "Type")).toLowerCase();
      const amt = toNumber(pick(r, "Amount"));
      const date = parseDateSortable(pick(r, "Date"));

      if (!map.has(member)) {
        map.set(member, { member, deposits:0, withdrawals:0, lastDepositDate: null });
      }
      const s = map.get(member);

      if (type === "deposit") {
        s.deposits += amt;
        if (date && (!s.lastDepositDate || date > s.lastDepositDate)) s.lastDepositDate = date;
      } else if (type === "withdrawal") {
        s.withdrawals += amt;
      }
    }

    membersSummary = Array.from(map.values())
      .map(s => ({...s, net: s.deposits - s.withdrawals}))
      .sort((a,b)=> b.deposits - a.deposits);
  }

  function renderMembers() {
    const q = cleanStr(document.getElementById("memberSearch").value).toLowerCase();
    const rows = q
      ? membersSummary.filter(m => m.member.toLowerCase().includes(q))
      : membersSummary;

    const tbody = document.getElementById("membersRows");
    tbody.innerHTML = "";

    for (const m of rows) {
      const tr = document.createElement("tr");
      tr.className = "clickable";
      tr.innerHTML = `
        <td>${m.member}</td>
        <td>${money(m.deposits)}</td>
        <td>${money(m.withdrawals)}</td>
        <td>${money(m.net)}</td>
        <td>${m.lastDepositDate || ""}</td>
      `;
      tr.onclick = () => {
        document.getElementById("memberSelect").value = m.member;
        showTab("statement");
        renderStatement();
      };
      tbody.appendChild(tr);
    }
  }

  function renderStatement() {
    const member = normalizeSpaces(document.getElementById("memberSelect").value);
    const hint = document.getElementById("mHint");
    const tbody = document.getElementById("statementRows");

    if (!member) {
      hint.textContent = "Pick a member to see how and when they contributed.";
      document.getElementById("mDeposits").textContent = "—";
      document.getElementById("mWithdrawals").textContent = "—";
      document.getElementById("mNet").textContent = "—";
      tbody.innerHTML = "";
      return;
    }

    const rows = allRows
      .filter(r => normalizeSpaces(pick(r,"Member")) === member)
      .map(r => ({
        Date: parseDateSortable(pick(r,"Date")) || cleanStr(pick(r,"Date")),
        Type: normalizeType(pick(r,"Type")),
        Amount: cleanStr(pick(r,"Amount")),
        Note: cleanStr(pick(r,"Note"))
      }))
      .sort((a,b) => (b.Date || "").localeCompare(a.Date || ""));

    const t = totals(rows);
    document.getElementById("mDeposits").textContent = money(t.dep);
    document.getElementById("mWithdrawals").textContent = money(t.wd);
    document.getElementById("mNet").textContent = money(t.bal);

    hint.textContent = `Statement for: ${member} (since group began)`;
    tbody.innerHTML = "";

    for (const r of rows) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.Date || ""}</td>
        <td>${r.Type || ""}</td>
        <td>${r.Amount || ""}</td>
        <td>${r.Note || ""}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function downloadCSV(rows, filename) {
    const headers = ["Date","Member","Type","Amount","Note"];
    const lines = [headers.join(",")];

    for (const r of rows) {
      const values = [
        cleanStr(r.Date ?? pick(r,"Date")),
        normalizeSpaces(r.Member ?? pick(r,"Member")),
        normalizeType(r.Type ?? pick(r,"Type")),
        cleanStr(r.Amount ?? pick(r,"Amount")),
        cleanStr(r.Note ?? pick(r,"Note"))
      ].map(v => `"${String(v).replace(/"/g,'""')}"`);
      lines.push(values.join(","));
    }

    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function downloadMemberStatement() {
    const member = normalizeSpaces(document.getElementById("memberSelect").value);
    if (!member) { alert("Select a member first."); return; }

    const rows = allRows
      .filter(r => normalizeSpaces(pick(r,"Member")) === member)
      .map(r => ({
        Date: parseDateSortable(pick(r,"Date")) || cleanStr(pick(r,"Date")),
        Member: member,
        Type: normalizeType(pick(r,"Type")),
        Amount: cleanStr(pick(r,"Amount")),
        Note: cleanStr(pick(r,"Note"))
      }))
      .sort((a,b) => (a.Date || "").localeCompare(b.Date || "")); // chronological

    downloadCSV(rows, `${member.replace(/\s+/g,"_")}_statement.csv`);
  }

  async function loadData(manual=false) {
    setStatus(manual ? "Refreshing…" : "Loading…", "warn");

    try {
      const url = DATA_URL + (DATA_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url);
      if (!res.ok) throw new Error("Fetch failed: " + res.status);

      const textRaw = await res.text();
      const text = cleanStr(textRaw);

      if (text.toLowerCase().includes("<html")) {
        setStatus("Not public/published (HTML returned)", "err");
        allRows = [];
        return;
      }

      const firstLine = (text.split(/\r?\n/)[0] || "");
      const delim = detectDelimiter(firstLine);

      const parsed = parseDelimited(text, delim);

      allRows = parsed
        .map(r => ({
          Date: parseDateSortable(pick(r,"Date")) || cleanStr(pick(r,"Date")),
          Member: normalizeSpaces(pick(r,"Member")),
          Type: normalizeType(pick(r,"Type")),
          Amount: cleanStr(pick(r,"Amount")),
          Note: cleanStr(pick(r,"Note"))
        }))
        .filter(r => (r.Date || r.Member || r.Type || r.Amount || r.Note));

      const tAll = totals(allRows);
      document.getElementById("totDeposits").textContent = money(tAll.dep);
      document.getElementById("totWithdrawals").textContent = money(tAll.wd);
      document.getElementById("totBalance").textContent = money(tAll.bal);

      computeMembersSummary();
      document.getElementById("memberCount").textContent = membersSummary.length.toLocaleString();

      buildMemberSelectOptions();
      renderMembers();
      renderStatement();

      document.getElementById("updated").textContent = new Date().toLocaleString();
      setStatus(allRows.length ? "Live" : "Live (0 rows)", allRows.length ? "ok" : "warn");
    } catch (e) {
      console.error(e);
      setStatus("Error loading data", "err");
    }
  }

  loadData(false);
  setInterval(() => loadData(false), 30000);
</script>
</body>
</html>
