<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Group Savings Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.4; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin: 16px 0; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    .big { font-size: 22px; font-weight: 700; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
    th { background: #fafafa; position: sticky; top: 0; }
    .muted { color: #666; font-size: 13px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input { padding: 10px; border:1px solid #ddd; border-radius: 8px; min-width: 240px; }
    button { padding: 10px 12px; border:1px solid #ddd; border-radius: 8px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Group Savings Portal</h1>
  <div class="row">
    <div class="muted" id="status">Loading…</div>
    <button onclick="loadData(true)">Refresh</button>
    <input id="search" placeholder="Search member / note…" oninput="render()" />
  </div>

  <div class="cards">
    <div class="card">
      <div class="muted">Total Deposits</div>
      <div class="big" id="deposits">—</div>
    </div>
    <div class="card">
      <div class="muted">Total Withdrawals</div>
      <div class="big" id="withdrawals">—</div>
    </div>
    <div class="card">
      <div class="muted">Current Balance</div>
      <div class="big" id="balance">—</div>
    </div>
    <div class="card">
      <div class="muted">Last Updated</div>
      <div class="big" id="updated">—</div>
    </div>
  </div>

  <h2>Transactions</h2>
  <div style="overflow:auto; max-height: 70vh; border:1px solid #eee; border-radius:10px;">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Member</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

<script>
  const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTgt59-GVyVkiFgAkNHa2ngI71zTrMyYclh_YrgDL29HTCmEe7BdXJtbzGD5J53OdxYRiUu7S6CYa82/pub?gid=627544282&single=true&output=csv";

  let allRows = [];

  // ✅ Parses TAB-separated (TSV) data
  function parseTSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const headers = lines.shift().split("\t").map(h => h.trim());

    return lines.map(line => {
      const cols = line.split("\t");
      const obj = {};
      headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
      return obj;
    });
  }

  function money(n) {
    if (!isFinite(n)) return "0";
    return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  function toNumber(x) {
    const v = String(x ?? "").replace(/,/g, "").replace(/[^\d.\-]/g, "").trim();
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  }

  function pick(row, key) {
    if (row[key] != null) return row[key];
    const found = Object.keys(row).find(h => h.toLowerCase() === key.toLowerCase());
    return found ? row[found] : "";
  }

  function calcTotals(rows) {
    let deposits = 0, withdrawals = 0;
    for (const r of rows) {
      const type = (pick(r, "Type") || "").toLowerCase();
      const amt = toNumber(pick(r, "Amount"));
      if (type.includes("deposit") || type.includes("contribution") || type.includes("credit")) deposits += amt;
      else if (type.includes("withdraw") || type.includes("debit")) withdrawals += amt;
    }
    return { deposits, withdrawals, balance: deposits - withdrawals };
  }

  function render() {
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    const rows = q
      ? allRows.filter(r =>
          (pick(r, "Member") || "").toLowerCase().includes(q) ||
          (pick(r, "Note") || "").toLowerCase().includes(q) ||
          (pick(r, "Type") || "").toLowerCase().includes(q) ||
          (pick(r, "Date") || "").toLowerCase().includes(q)
        )
      : allRows;

    const t = calcTotals(allRows);
    document.getElementById("deposits").textContent = money(t.deposits);
    document.getElementById("withdrawals").textContent = money(t.withdrawals);
    document.getElementById("balance").textContent = money(t.balance);

    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    const sorted = [...rows].reverse(); // latest first
    for (const r of sorted) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${pick(r, "Date")}</td>
        <td>${pick(r, "Member")}</td>
        <td>${pick(r, "Type")}</td>
        <td>${pick(r, "Amount")}</td>
        <td>${pick(r, "Note")}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function loadData(manual=false) {
    const status = document.getElementById("status");
    status.textContent = manual ? "Refreshing…" : "Loading…";

    try {
      const url = DATA_URL + (DATA_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url);
      if (!res.ok) throw new Error("Failed to fetch data");
      const text = await res.text();

      // If the file is actually comma CSV, this will look wrong,
      // but since your header is tab-separated, we parse as TSV.
      allRows = parseTSV(text).filter(r => Object.keys(r).length);

      document.getElementById("updated").textContent = new Date().toLocaleString();
      status.textContent = "Live";
      render();
    } catch (e) {
      status.textContent = "Error loading data. Check publish settings.";
      console.error(e);
    }
  }

  loadData(false);
  setInterval(() => loadData(false), 30000);
</script>
</body>
</html>
