<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Group Savings Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.4; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin: 16px 0; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    .big { font-size: 22px; font-weight: 700; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
    th { background: #fafafa; position: sticky; top: 0; }
    .muted { color: #666; font-size: 13px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0; }
    input, select { padding: 10px; border:1px solid #ddd; border-radius: 8px; min-width: 240px; }
    button { padding: 10px 12px; border:1px solid #ddd; border-radius: 8px; cursor:pointer; }
    .split { display:grid; grid-template-columns: 1fr; gap: 14px; }
    @media(min-width: 980px){ .split { grid-template-columns: 1.2fr 0.8fr; } }
    .box { border:1px solid #eee; border-radius: 10px; padding: 12px; }
  </style>
</head>
<body>
  <h1>Group Savings Portal</h1>

  <div class="row">
    <div class="muted" id="status">Loading…</div>
    <button onclick="loadData(true)">Refresh</button>
    <input id="search" placeholder="Search member / note…" oninput="render()" />
  </div>

  <div class="cards">
    <div class="card">
      <div class="muted">Total Deposits</div>
      <div class="big" id="deposits">—</div>
    </div>
    <div class="card">
      <div class="muted">Total Withdrawals</div>
      <div class="big" id="withdrawals">—</div>
    </div>
    <div class="card">
      <div class="muted">Current Balance</div>
      <div class="big" id="balance">—</div>
    </div>
    <div class="card">
      <div class="muted">Last Updated</div>
      <div class="big" id="updated">—</div>
    </div>
  </div>

  <div class="split">
    <div class="box">
      <h2>All Transactions</h2>
      <div style="overflow:auto; max-height: 60vh;">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Member</th><th>Type</th><th>Amount</th><th>Note</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <div class="box">
      <h2>Member View</h2>
      <div class="row">
        <select id="memberSelect" onchange="renderMember()">
          <option value="">Select a member…</option>
        </select>
      </div>

      <div class="cards" style="margin-top:0;">
        <div class="card">
          <div class="muted">Member Deposits (since start)</div>
          <div class="big" id="mDeposits">—</div>
        </div>
        <div class="card">
          <div class="muted">Member Withdrawals</div>
          <div class="big" id="mWithdrawals">—</div>
        </div>
        <div class="card">
          <div class="muted">Member Net</div>
          <div class="big" id="mNet">—</div>
        </div>
      </div>

      <h3 style="margin-top:10px;">Contribution History</h3>
      <div class="muted" id="mHint">Pick a member to see when they contributed.</div>
      <div style="overflow:auto; max-height: 45vh; border:1px solid #eee; border-radius:10px;">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Type</th><th>Amount</th><th>Note</th>
            </tr>
          </thead>
          <tbody id="memberRows"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTgt59-GVyVkiFgAkNHa2ngI71zTrMyYclh_YrgDL29HTCmEe7BdXJtbzGD5J53OdxYRiUu7S6CYa82/pub?gid=627544282&single=true&output=csv";

  let allRows = [];

  function parseCSV(text) {
    const rows = [];
    let row = [], cell = "", inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (c === '"' && inQuotes && next === '"') { cell += '"'; i++; }
      else if (c === '"') { inQuotes = !inQuotes; }
      else if (c === ',' && !inQuotes) { row.push(cell); cell = ""; }
      else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (c === '\r' && next === '\n') i++;
        row.push(cell);
        if (row.some(x => x !== "")) rows.push(row);
        row = []; cell = "";
      } else { cell += c; }
    }
    row.push(cell);
    if (row.some(x => x !== "")) rows.push(row);

    const headers = (rows.shift() || []).map(h => h.trim());
    return rows.map(cols => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
      return obj;
    });
  }

  function parseTSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const headers = (lines.shift() || "").split("\t").map(h => h.trim());
    return lines.map(line => {
      const cols = line.split("\t");
      const obj = {};
      headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
      return obj;
    });
  }

  function parseData(text) {
    const firstLine = (text.split(/\r?\n/)[0] || "");
    return firstLine.includes("\t") ? parseTSV(text) : parseCSV(text);
  }

  function money(n) {
    if (!isFinite(n)) return "0";
    return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
  }

  function toNumber(x) {
    const v = String(x ?? "").replace(/,/g, "").replace(/[^\d.\-]/g, "").trim();
    const n = Number(v);
    return isNaN(n) ? 0 : n;
  }

  function pick(row, ...keys) {
    for (const k of keys) {
      if (row[k] != null && row[k] !== "") return row[k];
      const found = Object.keys(row).find(h => h.toLowerCase() === k.toLowerCase());
      if (found) return row[found];
    }
    return "";
  }

  function normalizeName(x) {
    return String(x || "").trim().replace(/\s+/g, " ");
  }

  function calcTotals(rows) {
    let deposits = 0, withdrawals = 0;
    for (const r of rows) {
      const type = (pick(r, "Type") || "").toLowerCase();
      const amt = toNumber(pick(r, "Amount"));
      if (type.includes("deposit") || type.includes("contribution") || type.includes("credit")) deposits += amt;
      else if (type.includes("withdraw") || type.includes("debit")) withdrawals += amt;
    }
    return { deposits, withdrawals, balance: deposits - withdrawals };
  }

  function buildMemberList() {
    const sel = document.getElementById("memberSelect");
    const current = sel.value;

    const members = Array.from(new Set(
      allRows.map(r => normalizeName(pick(r, "Member", "Name"))).filter(Boolean)
    )).sort((a,b) => a.localeCompare(b));

    sel.innerHTML = `<option value="">Select a member…</option>` + members.map(m =>
      `<option value="${m.replace(/"/g, "&quot;")}">${m}</option>`
    ).join("");

    if (members.includes(current)) sel.value = current;
  }

  function render() {
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    const rows = q
      ? allRows.filter(r =>
          normalizeName(pick(r, "Member", "Name")).toLowerCase().includes(q) ||
          (pick(r, "Note", "Description", "Details") || "").toLowerCase().includes(q) ||
          (pick(r, "Type") || "").toLowerCase().includes(q) ||
          (pick(r, "Date") || "").toLowerCase().includes(q)
        )
      : allRows;

    const t = calcTotals(allRows);
    document.getElementById("deposits").textContent = money(t.deposits);
    document.getElementById("withdrawals").textContent = money(t.withdrawals);
    document.getElementById("balance").textContent = money(t.balance);

    const tbody = document.getElementById("rows");
    tbody.innerHTML = "";

    const sorted = [...rows].reverse();
    for (const r of sorted) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${pick(r, "Date")}</td>
        <td>${normalizeName(pick(r, "Member", "Name"))}</td>
        <td>${pick(r, "Type")}</td>
        <td>${pick(r, "Amount")}</td>
        <td>${pick(r, "Note", "Description", "Details")}</td>
      `;
      tbody.appendChild(tr);
    }

    buildMemberList();
    renderMember();
  }

  function renderMember() {
    const member = normalizeName(document.getElementById("memberSelect").value);
    const hint = document.getElementById("mHint");
    const tbody = document.getElementById("memberRows");

    if (!member) {
      hint.textContent = "Pick a member to see when they contributed.";
      document.getElementById("mDeposits").textContent = "—";
      document.getElementById("mWithdrawals").textContent = "—";
      document.getElementById("mNet").textContent = "—";
      tbody.innerHTML = "";
      return;
    }

    const rows = allRows.filter(r => normalizeName(pick(r, "Member", "Name")) === member);

    let dep = 0, wd = 0;
    for (const r of rows) {
      const type = (pick(r, "Type") || "").toLowerCase();
      const amt = toNumber(pick(r, "Amount"));
      if (type.includes("deposit") || type.includes("contribution") || type.includes("credit")) dep += amt;
      else if (type.includes("withdraw") || type.includes("debit")) wd += amt;
    }

    document.getElementById("mDeposits").textContent = money(dep);
    document.getElementById("mWithdrawals").textContent = money(wd);
    document.getElementById("mNet").textContent = money(dep - wd);

    hint.textContent = `Showing all transactions for: ${member}`;
    tbody.innerHTML = "";

    const sorted = [...rows].reverse();
    for (const r of sorted) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${pick(r, "Date")}</td>
        <td>${pick(r, "Type")}</td>
        <td>${pick(r, "Amount")}</td>
        <td>${pick(r, "Note", "Description", "Details")}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function loadData(manual=false) {
    const status = document.getElementById("status");
    status.textContent = manual ? "Refreshing…" : "Loading…";

    try {
      const url = DATA_URL + (DATA_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url);
      if (!res.ok) throw new Error("Fetch failed");
      const text = await res.text();

      if (text.toLowerCase().includes("<html")) {
        status.textContent = "Not public. Re-publish sheet as CSV (Publish to web).";
        return;
      }

      allRows = parseData(text).filter(r =>
        Object.keys(r).some(k => String(r[k] ?? "").trim() !== "")
      );

      document.getElementById("updated").textContent = new Date().toLocaleString();
      status.textContent = allRows.length ? "Live" : "Live (0 rows found)";
      render();
    } catch (e) {
      status.textContent = "Error loading data. Check publish settings.";
      console.error(e);
    }
  }

  loadData(false);
  setInterval(() => loadData(false), 30000);
</script>
</body>
</html>
